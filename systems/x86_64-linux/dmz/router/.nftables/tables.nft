table inet filter {
    chain output {
        type filter hook output priority 100; policy accept;
    }
    chain input {
        type filter hook input priority filter; policy drop;

        iifname "lo" accept comment "Allow loopback traffic";

        ct state { established, related } counter accept comment "Allow established connections";

        iifname {
            "vl10.homelab",
            "vl20.gaming",
            "wireguard"
        } counter accept comment "Allow VLANs and VPN to access the router";

        # ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        # ┃              Port Forwarding              ┃
        # ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

        iifname "eth0" tcp dport 64022 counter accept comment "Allow SSH connections (custom port)";
        iifname "eth0" udp dport 51820 counter accept comment "Allow WireGuard connections";
        iifname "eth0" tcp dport 61640 counter accept comment "Allow TCP qBitTorrent Seeder";
        iifname "eth0" udp dport 61640 counter accept comment "Allow UDP qBitTorrent Seeder";

        iifname "eth0" drop comment "Drop all other Internet traffic";
    }
    chain forward {
        type filter hook forward priority filter; policy drop;
        ct state established,related accept comment "Allow already established traffic";

        # ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        # ┃                  WAN/LAN                  ┃
        # ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

        iifname {
            "vl10.homelab",
            "vl20.gaming",
            "wireguard"
        } oifname "eth0" counter accept comment "Allow VLANs and VPN access to the Internet";

        # ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        # ┃               VLAN: HomeLab               ┃
        # ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

        iifname "eth0" oifname "vl10.homelab" ct state new,established,related counter accept comment "Allow port forwarding from Internet to Homelab";
        
        iifname "vl10.homelab" oifname "vl10.homelab" ip daddr 10.0.10.254 counter accept comment "Allow Homelab traffic to Homelab router";
        iifname "vl10.homelab" oifname "vl10.homelab" counter drop comment "Block Homelab traffic to other Homelab servers";

        iifname "vl10.homelab" oifname "eth0" ip daddr 192.168.1.3 tcp dport { 139, 445 } counter accept comment "Allow Homelab VLAN to SMB server TCP";
        iifname "vl10.homelab" oifname "eth0" ip daddr 192.168.1.3 udp dport { 137, 138 } counter accept comment "Allow Homelab VLAN to SMB server UDP";

        # ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        # ┃               VLAN: Gaming                ┃
        # ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

        iifname "vl20.gaming" oifname "vl20.gaming" ip daddr 10.0.20.254 counter accept comment "Allow Gaming traffic to Gaming router";
        iifname "vl20.gaming" oifname "vl20.gaming" counter drop comment "Block Gaming traffic to other Gaming servers";

        iifname "vl20.gaming" oifname "eth0" ip daddr 192.168.1.3 tcp dport { 139, 445 } counter accept comment "Allow Gaming VLAN to SMB server TCP";
        iifname "vl20.gaming" oifname "eth0" ip daddr 192.168.1.3 udp dport { 137, 138 } counter accept comment "Allow Gaming VLAN to SMB server UDP";

        # ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        # ┃                 WireGuard                 ┃
        # ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

        iifname "wireguard" oifname "wireguard" ip daddr 10.10.10.254 counter accept comment "Allow WireGuard traffic to WireGuard router";
        iifname "wireguard" oifname "wireguard" counter drop comment "Block WireGuard traffic to other WireGuard clients";

        iifname "wireguard" oifname { "vl10.homelab", "vl20.gaming" } tcp dport { 22, 64022 } counter accept comment "Allow WireGuard SSH access to VLANs";
        iifname "wireguard" oifname "vl10.homelab" ip daddr 10.0.10.1 tcp dport 443 counter accept comment "Allow WireGuard HTTPS access to Homelab reverse proxy";
    }
}
table ip nat {
    chain prerouting {
        type nat hook prerouting priority filter; policy accept;

        # ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        # ┃           Port Forwarding 61640           ┃
        # ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

        iifname "eth0" tcp dport 61640 dnat to 10.0.10.3:61640 comment "Forward TCP qBitTorrent Seeder to 10.0.10.3";
        iifname "eth0" udp dport 61640 dnat to 10.0.10.3:61640 comment "Forward UDP qBitTorrent Seeder to 10.0.10.3";
    }
    chain postrouting {
        type nat hook postrouting priority filter; policy accept;
        oifname "eth0" masquerade comment "NAT for Internet access";
    }
}